(function() {

  /**
  * Base View for all CartoDB views.
  * DO NOT USE Backbone.View directly
  */
  var View = gbif.core.View = Backbone.View.extend({

    constructor: function(options) {
      this._models = [];
      this._subviews = {};
      Backbone.View.call(this, options);
      View.viewCount++;
      View.views[this.cid] = this;
      this._created_at = new Date();
      gbif.core.Profiler.new_value('total_views', View.viewCount);
    },

    add_related_model: function(m) {
      this._models.push(m);
    },

    addView: function(v) {
      this._subviews[v.cid] = v;
      v._parent = this;
    },

    removeView: function(v) {
      delete this._subviews[v.cid];
    },

    clearSubViews: function() {
      _(this._subviews).each(function(v) {
        v.clean();
      });
      this._subviews = {};
    },

    /**
    * this methid clean removes the view
    * and clean and events associated. call it when
    * the view is not going to be used anymore
    */
    clean: function() {
      var self = this;
      this.trigger('clean');
      this.clearSubViews();
      // remove from parent
      if(this._parent) {
        this._parent.removeView(this);
      }
      this.remove();
      this.unbind();
      // remove model binding
      _(this._models).each(function(m) {
        m.unbind(null, null, self);
      });
      this._models = [];
      View.viewCount--;
      delete View.views[this.cid];
    },

    /**
    * utility methods
    */

    getTemplate: function(tmpl) {
      if(this.options.template) {
        return  _.template(this.options.template);
      }
      return gbif.templates.getTemplate(tmpl);
    },

    show: function() {
      this.$el.show();
    },

    hide: function() {
      this.$el.hide();
    }

  }, {
    viewCount: 0,
    views: {},

    /**
    * when a view with events is inherit and you want to add more events
    * this helper can be used:
    * var MyView = new core.View({
    *  events: gbif.core.View.extendEvents({
    *      'click': 'fn'
    *  })
    * });
    */
    extendEvents: function(newEvents) {
      return function() {
        return _.extend(newEvents, this.constructor.__super__.events);
      };
    },

    /**
    * search for views in a view and check if they are added as subviews
    */
    runChecker: function() {
      _.each(gbif.core.View.views, function(view) {
        _.each(view, function(prop, k) {
          if( k !== '_parent' &&
            view.hasOwnProperty(k) &&
            prop instanceof gbif.core.View &&
          view._subviews[prop.cid] === undefined) {
            console.log("=========");
            console.log("untracked view: ");
            console.log(prop.el);
            console.log('parent');
            console.log(view.el);
            console.log(" ");
          }
        });
      });
    }
  });

})();
